{% extends "base.html" %}

{% block title %}Panel Administrador - Sistema de Clientes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main content -->
        <div class="col-12 main-content mx-auto" style="max-width: 1400px; height: 100vh; overflow-y: auto;">
            <!-- Header Principal con Hamburguesa -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <div class="d-flex align-items-center">
                    <!-- BotÃ³n Hamburguesa -->
                    <button class="btn btn-outline-primary btn-sm me-3" type="button" id="adminMenuBtn" data-bs-toggle="offcanvas" data-bs-target="#adminOffcanvas" 
                            style="border-radius: 8px; padding: 8px 12px;">
                        â˜° <span class="d-none d-sm-inline">MenÃº</span>
                    </button>
                    <h1 class="h4 h-md-2 mb-0">ğŸŒ Admin - Mundo Escolar</h1>
                </div>
                
                <div class="btn-toolbar mb-2 mb-md-0">
                    <!-- Estado GPS -->
                    <div class="me-3 d-none d-md-block">
                        <small id="estado-ubicacion-admin" class="text-muted">
                            ğŸ“ GPS: No activado
                        </small>
                    </div>
                    
                    <!-- Buscador -->
                    <div class="me-2 position-relative" id="buscador-container-admin">
                        <input type="text" 
                            class="form-control" 
                            id="buscador-clientes" 
                            placeholder="ğŸ” Buscar cliente..."
                            style="width: 200px;"
                            autocomplete="off">
                            
                        <!-- Panel de sugerencias -->
                        <div class="dropdown-menu position-absolute" id="sugerencias-container-admin" 
                            style="display: none; max-height: 300px; overflow-y: auto; width: 100%; z-index: 1050; top: 100%; left: 0;">
                            <div id="lista-sugerencias-admin">
                                <!-- Las sugerencias se cargarÃ¡n aquÃ­ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- BotÃ³n GPS -->
                    <button class="btn btn-warning btn-sm me-2" type="button" id="btn-actualizar-ubicacion-admin"
                            title="Activar GPS en panel admin">
                        ğŸš€ GPS
                    </button>
                    
                    <!-- Contador -->
                    <div class="btn-group">
                        <span class="btn btn-sm btn-outline-secondary" id="contador-clientes">
                            Cargando...
                        </span>
                    </div>
                </div>
            </div>

            <!-- Estado GPS para mÃ³vil -->
            <div class="d-md-none mb-3">
                <small id="estado-ubicacion-admin-mobile" class="text-muted">
                    ğŸ“ GPS: No activado
                </small>
            </div>

            <!-- Mapa -->
            <div class="card mx-auto" style="max-width: 1400px;">
                <div class="card-header">
                    <h5 class="card-title mb-0">ğŸ—ºï¸ Mapa de Clientes</h5>
                </div>
                <div class="card-body p-0">
                    <div id="map-admin" style="height: 600px; width: 100%; border-radius: 0 0 8px 8px;"></div>
                </div>
            </div>

            <!-- Lista de Clientes -->
            <div class="card mt-4 mx-auto" style="max-width: 1400px;">
                <div class="card-header">
                    <h5 class="card-title mb-0">ğŸ“‹ Lista de Clientes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabla-clientes">
                            <thead>
                                <tr>
                                    <th class="d-none d-md-table-cell">Nombre</th>
                                    <th class="d-none d-lg-table-cell">DirecciÃ³n</th>
                                    <th class="d-none d-sm-table-cell">TelÃ©fono</th>
                                    <th class="d-none d-sm-table-cell">CategorÃ­a</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpo-tabla-clientes">
                                <!-- Los clientes se cargarÃ¡n aquÃ­ con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ”¥ NUEVO: MenÃº Hamburguesa Profesional -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="adminOffcanvas" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
    <div class="offcanvas-header border-bottom" style="background: white;">
        <h5 class="offcanvas-title fw-bold">ğŸ“Š Panel de Control</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active py-3 border-bottom" href="#" id="btn-ver-clientes" data-bs-dismiss="offcanvas" 
                   style="transition: all 0.3s ease; border-left: 4px solid #0d6efd;">
                    ğŸ‘¥ <strong>Ver Todos los Clientes</strong>
                </a>
            </li>
                <li class="nav-item">
                    <a class="nav-link py-3 border-bottom" href="/admin/backup" target="_blank"
                    style="transition: all 0.3s ease;">
                        ğŸ’¾ <strong>Descargar Backup Completo</strong>
                    </a>
                <li class="nav-item">
                     <a class="nav-link py-3 border-bottom" href="/admin/estado-db" target="_blank"
                     style="transition: all 0.3s ease;">
                        ğŸ“Š <strong>Estado Base de Datos</strong>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link py-3 border-bottom" href="/admin/restore" target="_blank"
                    style="transition: all 0.3s ease;">
                        ğŸ”„ <strong>Restaurar desde Backup</strong>
                    </a>
                </li>
            <li class="nav-item">
                <a class="nav-link py-3 border-bottom" href="#" data-bs-toggle="modal" data-bs-target="#agregarClienteModal" data-bs-dismiss="offcanvas"
                   style="transition: all 0.3s ease;">
                    â• <strong>Agregar Nuevo Cliente</strong>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link py-3 border-bottom" href="#" data-bs-toggle="modal" data-bs-target="#gestionUsuariosModal" data-bs-dismiss="offcanvas"
                   style="transition: all 0.3s ease;">
                    ğŸ‘¥ <strong>GestiÃ³n de Usuarios</strong>
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Modal para Agregar Cliente - MEJORADO -->
<div class="modal fade" id="agregarClienteModal" tabindex="-1" aria-labelledby="agregarClienteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="agregarClienteModalLabel">â• Agregar Nuevo Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-agregar-cliente">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 position-relative">
                                <label for="nombre" class="form-label">Nombre del Cliente *</label>
                                <input type="text" class="form-control" id="nombre" name="nombre" required 
                                    autocomplete="off" placeholder="Escribe el nombre del cliente...">
                                
                                <!-- ğŸ”¥ NUEVO: Contenedor de sugerencias para evitar duplicados -->
                                <div class="sugerencias-dropdown" id="sugerencias-nombre" style="display: none;">
                                    <div id="lista-sugerencias-nombre">
                                        <!-- Las sugerencias se cargarÃ¡n aquÃ­ automÃ¡ticamente -->
                                    </div>
                                </div>
                                
                                <small class="form-text text-muted">
                                    ğŸ’¡ Se mostrarÃ¡n coincidencias para evitar duplicados
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefono" class="form-label">TelÃ©fono</label>
                                <input type="text" class="form-control" id="telefono" name="telefono">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="direccion" class="form-label">DirecciÃ³n *</label>
                        <input type="text" class="form-control" id="direccion" name="direccion" required>
                        <small class="form-text text-muted">Puedes pegar un link de Google Maps o escribir la direcciÃ³n</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="latitud" class="form-label">Latitud *</label>
                                <input type="number" step="any" class="form-control" id="latitud" name="latitud" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="longitud" class="form-label">Longitud *</label>
                                <input type="number" step="any" class="form-control" id="longitud" name="longitud" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="categoria" class="form-label">CategorÃ­a</label>
                        <select class="form-select" id="categoria" name="categoria">
                            <option value="LibrerÃ­a">ğŸ“š LibrerÃ­a</option>
                            <option value="PapelerÃ­a">ğŸ“„ PapelerÃ­a</option>
                            <option value="Tienda Escolar">ğŸ’ Tienda Escolar</option>
                            <option value="Colegio">ğŸ« Colegio</option>
                            <option value="Universidad">ğŸ“ Universidad</option>
                            <option value="Oficina">ğŸ¢ Oficina</option>
                            <option value="Distribuidor">ğŸšš Distribuidor</option>
                            <option value="Bodega">ğŸ­ Bodega</option>
                            <option value="Casa">ğŸ  Casa</option>
                            <option value="Otro">ğŸ“¦ Otro</option>
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <small>ğŸ’¡ <strong>Consejo:</strong> Para obtener coordenadas, ve a <a href="https://maps.google.com" target="_blank">Google Maps</a>, haz clic derecho en cualquier ubicaciÃ³n y selecciona "Â¿QuÃ© hay aquÃ­?"</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-cliente">Guardar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Cliente - MEJORADO -->
<div class="modal fade" id="editarClienteModal" tabindex="-1" aria-labelledby="editarClienteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editarClienteModalLabel">âœï¸ Editar Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-editar-cliente">
                    <input type="hidden" id="editar-cliente-id" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar-nombre" class="form-label">Nombre del Cliente *</label>
                                <input type="text" class="form-control" id="editar-nombre" name="nombre" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar-telefono" class="form-label">TelÃ©fono</label>
                                <input type="text" class="form-control" id="editar-telefono" name="telefono">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar-direccion" class="form-label">DirecciÃ³n *</label>
                        <input type="text" class="form-control" id="editar-direccion" name="direccion" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar-latitud" class="form-label">Latitud *</label>
                                <input type="number" step="any" class="form-control" id="editar-latitud" name="latitud" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar-longitud" class="form-label">Longitud *</label>
                                <input type="number" step="any" class="form-control" id="editar-longitud" name="longitud" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editar-categoria" class="form-label">CategorÃ­a</label>
                        <select class="form-select" id="editar-categoria" name="categoria">
                            <option value="LibrerÃ­a">ğŸ“š LibrerÃ­a</option>
                            <option value="PapelerÃ­a">ğŸ“„ PapelerÃ­a</option>
                            <option value="Tienda Escolar">ğŸ’ Tienda Escolar</option>
                            <option value="Colegio">ğŸ« Colegio</option>
                            <option value="Universidad">ğŸ“ Universidad</option>
                            <option value="Oficina">ğŸ¢ Oficina</option>
                            <option value="Distribuidor">ğŸšš Distribuidor</option>
                            <option value="Bodega">ğŸ­ Bodega</option>
                            <option value="Casa">ğŸ  Casa</option>
                            <option value="Otro">ğŸ“¦ Otro</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-actualizar-cliente">ğŸ’¾ Actualizar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para GestiÃ³n de Usuarios - MEJORADO -->
<div class="modal fade" id="gestionUsuariosModal" tabindex="-1" aria-labelledby="gestionUsuariosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="gestionUsuariosModalLabel">ğŸ‘¥ GestiÃ³n de Usuarios</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Alertas -->
                <div id="alert-usuarios" class="alert" style="display: none;"></div>

                <div class="row">
                    <!-- Formulario para crear usuario -->
                    <div class="col-md-5">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">â• Crear Nuevo Usuario</h5>
                            </div>
                            <div class="card-body">
                                <form id="form-crear-usuario">
                                    <div class="mb-3">
                                        <label for="username" class="form-label">Usuario *</label>
                                        <input type="text" class="form-control" id="username" name="username" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="password" class="form-label">ContraseÃ±a *</label>
                                        <input type="password" class="form-control" id="password" name="password" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="role" class="form-label">Tipo de Usuario *</label>
                                        <select class="form-select" id="role" name="role" required>
                                            <option value="trabajador">ğŸš— Trabajador</option>
                                            <option value="admin">ğŸ‘‘ Administrador</option>
                                        </select>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success w-100" id="btn-crear-usuario">
                                        Crear Usuario
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de usuarios existentes -->
                    <div class="col-md-7">
                        <div class="card h-100">
                            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">ğŸ“‹ Usuarios del Sistema</h5>
                                <span class="badge bg-light text-dark" id="contador-usuarios">0 usuarios</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Usuario</th>
                                                <th>Tipo</th>
                                                <th>Estado</th>
                                                <th>Ãšltimo Acceso</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabla-usuarios-body">
                                            <!-- Los usuarios se cargarÃ¡n con JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Usuario - MEJORADO -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-labelledby="modalEditarUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalEditarUsuarioLabel">âœï¸ Editar Usuario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-editar-usuario">
                    <input type="hidden" id="editar-usuario-id">
                    
                    <div class="mb-3">
                        <label for="editar-username" class="form-label">Usuario *</label>
                        <input type="text" class="form-control" id="editar-username" name="username" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar-role" class="form-label">Tipo de Usuario *</label>
                        <select class="form-select" id="editar-role" name="role" required>
                            <option value="trabajador">ğŸš— Trabajador</option>
                            <option value="admin">ğŸ‘‘ Administrador</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar-password" class="form-label">Nueva ContraseÃ±a (dejar vacÃ­o para no cambiar)</label>
                        <input type="password" class="form-control" id="editar-password" name="password">
                        <div class="form-text">Si no quieres cambiar la contraseÃ±a, deja este campo vacÃ­o</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editar-activo" name="activo">
                        <label class="form-check-label" for="editar-activo">Usuario activo</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-usuario">ğŸ’¾ Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaciÃ³n para eliminar usuario - MEJORADO -->
<div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="modalConfirmarEliminarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalConfirmarEliminarLabel">âš ï¸ Confirmar EliminaciÃ³n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Â¿EstÃ¡s seguro de que quieres eliminar al usuario <strong id="usuario-eliminar-nombre"></strong>?</p>
                <p class="text-danger"><small>Esta acciÃ³n no se puede deshacer.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-eliminar">ğŸ—‘ï¸ Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Reiniciar ContraseÃ±a - MEJORADO -->
<div class="modal fade" id="modalResetPassword" tabindex="-1" aria-labelledby="modalResetPasswordLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalResetPasswordLabel">ğŸ”‘ Reiniciar ContraseÃ±a</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Reiniciar contraseÃ±a para: <strong id="usuario-reset-nombre"></strong></p>
                <div class="mb-3">
                    <label for="nueva-password" class="form-label">Nueva ContraseÃ±a</label>
                    <input type="password" class="form-control" id="nueva-password" value="123456">
                    <div class="form-text">ContraseÃ±a por defecto: 123456</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btn-confirmar-reset">ğŸ”‘ Reiniciar ContraseÃ±a</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}

{% block styles %}
<style>
    /* ğŸ”¥ SCROLL INVISIBLE DEFINITIVO */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    
    .container-fluid {
        height: 100vh;
    }
    
    .row {
        height: 100%;
    }
    
    .main-content {
        height: 100%;
        overflow-y: auto;
        padding-bottom: 20px;
    }
    
    /* Scroll invisible */
    .main-content::-webkit-scrollbar {
        display: none;
    }
    
    .main-content {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* ğŸ”¥ MODALES PROFESIONALES */
    .modal-content {
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        border-radius: 12px 12px 0 0;
        border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    
    .modal-footer {
        border-radius: 0 0 12px 12px;
        border-top: 1px solid #dee2e6;
    }

    /* Responsive */
    @media (max-width: 576px) {
        .main-content {
            padding-left: 10px;
            padding-right: 10px;
        }
        #buscador-clientes {
            width: 150px !important;
        }
        
        .modal-dialog {
            margin: 10px;
        }
    }
    
    @media (max-width: 768px) {
        .modal-xl {
            max-width: 95%;
            margin: 10px auto;
        }
    }
</style>

<script>
// ğŸ”¥ SOLUCIÃ“N: Botones de backup en menÃº offcanvas
document.addEventListener('DOMContentLoaded', function() {
    // Forzar que los enlaces del menÃº funcionen
    const enlacesMenu = document.querySelectorAll('#adminOffcanvas a[href]');
    
    enlacesMenu.forEach(enlace => {
        enlace.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            
            // Si es un enlace de backup/estado, abrir en nueva pestaÃ±a
            if (href.includes('/admin/backup') || href.includes('/admin/estado-db')) {
                e.preventDefault();
                window.open(href, '_blank');
                
                // Cerrar el menÃº offcanvas
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('adminOffcanvas'));
                if (offcanvas) {
                    offcanvas.hide();
                }
            }
        });
    });
});
</script>

{% endblock %}