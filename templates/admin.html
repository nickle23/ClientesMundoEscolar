{% extends "base.html" %}

{% block title %}Panel Administrador - Sistema de Clientes{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main content -->
        <div class="col-12 main-content mx-auto" style="max-width: 1400px; height: 100vh; overflow-y: auto;">
            <!-- Header Principal con Hamburguesa -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom admin-header">
                <div class="d-flex align-items-center">
                    <!-- Bot√≥n Hamburguesa -->
                    <button class="btn btn-outline-primary btn-sm me-3" type="button" id="adminMenuBtn" data-bs-toggle="offcanvas" data-bs-target="#adminOffcanvas" 
                            style="border-radius: 8px; padding: 8px 12px;">
                        ‚ò∞ <span class="d-none d-sm-inline">Men√∫</span>
                    </button>
                    <h1 class="h4 h-md-2 mb-0">üåé Admin - Mundo Escolar</h1>
                </div>
                
                <div class="btn-toolbar mb-2 mb-md-0">
                    <!-- Estado GPS -->
                    <div class="me-3 d-none d-md-block">
                        <small id="estado-ubicacion-admin" class="text-muted">
                            üìç GPS: No activado
                        </small>
                    </div>
                    
                    <!-- Buscador -->
                    <div class="me-2 position-relative" id="buscador-container-admin">
                        <input type="text" 
                            class="form-control" 
                            id="buscador-clientes" 
                            placeholder="üîç Buscar cliente..."
                            style="width: 200px;"
                            autocomplete="off">
                            
                        <!-- Panel de sugerencias -->
                        <div class="dropdown-menu position-absolute" id="sugerencias-container-admin" 
                            style="display: none; max-height: 300px; overflow-y: auto; width: 100%; z-index: 1050; top: 100%; left: 0;">
                            <div id="lista-sugerencias-admin">
                                <!-- Las sugerencias se cargar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bot√≥n GPS -->
                    <button class="btn btn-warning btn-sm me-2" type="button" id="btn-actualizar-ubicacion-admin"
                            title="Activar GPS en panel admin">
                        üöÄ GPS
                    </button>
                    
                    <!-- Contador -->
                    <div class="btn-group">
                        <span class="btn btn-sm btn-outline-secondary" id="contador-clientes">
                            Cargando...
                        </span>
                    </div>
                </div>
            </div>

            <!-- Estado GPS para m√≥vil -->
            <div class="d-md-none mb-3">
                <small id="estado-ubicacion-admin-mobile" class="text-muted">
                    üìç GPS: No activado
                </small>
            </div>

            <!-- Mapa -->
            <div class="card mx-auto" style="max-width: 1400px;">
                <div class="card-header">
                    <h5 class="card-title mb-0">üó∫Ô∏è Mapa de Clientes</h5>
                </div>
                <div class="card-body p-0">
                    <div id="map-admin" style="height: 600px; width: 100%; border-radius: 0 0 8px 8px;"></div>
                </div>
            </div>

            <!-- Lista de Clientes - OCULTA INICIALMENTE -->
            <div class="card mt-4 mx-auto d-none" id="lista-clientes-original" style="max-width: 1400px;">
                <div class="card-header">
                    <h5 class="card-title mb-0">üìã Lista de Clientes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabla-clientes">
                            <thead>
                                <tr>
                                    <th class="d-none d-md-table-cell">Nombre</th>
                                    <th class="d-none d-lg-table-cell">Direcci√≥n</th>
                                    <th class="d-none d-sm-table-cell">Tel√©fono</th>
                                    <th class="d-none d-sm-table-cell">Categor√≠a</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpo-tabla-clientes">
                                <!-- Los clientes se cargar√°n aqu√≠ con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Men√∫ Hamburguesa Profesional -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="adminOffcanvas" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
    <div class="offcanvas-header border-bottom" style="background: white;">
        <h5 class="offcanvas-title fw-bold">üìä Panel de Control</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active py-3 border-bottom" href="#" data-bs-toggle="modal" data-bs-target="#modalTodosClientes" data-bs-dismiss="offcanvas" 
                style="transition: all 0.3s ease; border-left: 4px solid #0d6efd;">
                    üë• <strong>Ver Todos los Clientes</strong>
                </a>
            </li>
                <li class="nav-item">
                    <a class="nav-link py-3 border-bottom" href="/admin/backup" target="_blank"
                    style="transition: all 0.3s ease;">
                        üíæ <strong>Descargar Backup Completo</strong>
                    </a>
                <li class="nav-item">
                     <a class="nav-link py-3 border-bottom" href="/admin/estado-db" target="_blank"
                     style="transition: all 0.3s ease;">
                        üìä <strong>Estado Base de Datos</strong>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link py-3 border-bottom" href="/admin/restore" target="_blank"
                    style="transition: all 0.3s ease;">
                        üîÑ <strong>Restaurar desde Backup</strong>
                    </a>
                </li>
            <li class="nav-item">
                <a class="nav-link py-3 border-bottom" href="#" data-bs-toggle="modal" data-bs-target="#agregarClienteModal" data-bs-dismiss="offcanvas"
                   style="transition: all 0.3s ease;">
                    ‚ûï <strong>Agregar Nuevo Cliente</strong>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link py-3 border-bottom" href="#" data-bs-toggle="modal" data-bs-target="#gestionUsuariosModal" data-bs-dismiss="offcanvas"
                   style="transition: all 0.3s ease;">
                    üë• <strong>Gesti√≥n de Usuarios</strong>
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Modal para Agregar Cliente -->
<div class="modal fade modal-mobile-fixed" id="agregarClienteModal" tabindex="-1" aria-labelledby="agregarClienteModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-mobile">
        <div class="modal-content border-0 shadow-lg modal-mobile-content">
            <div class="modal-header bg-primary text-white py-3 modal-mobile-header">
                <h5 class="modal-title fw-bold" id="agregarClienteModalLabel">‚ûï Agregar Nuevo Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 modal-mobile-body">
                <form id="form-agregar-cliente">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 position-relative">
                                <label for="nombre" class="form-label">Nombre del Cliente *</label>
                                <input type="text" class="form-control" id="nombre" name="nombre" required 
                                    autocomplete="off" placeholder="Escribe el nombre del cliente...">
                                
                                <div class="sugerencias-dropdown" id="sugerencias-nombre" style="display: none;">
                                    <div id="lista-sugerencias-nombre">
                                        <!-- Las sugerencias se cargar√°n aqu√≠ autom√°ticamente -->
                                    </div>
                                </div>
                                
                                <small class="form-text text-muted">
                                    üí° Se mostrar√°n coincidencias para evitar duplicados
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefono" class="form-label">Tel√©fono</label>
                                <input type="text" class="form-control" id="telefono" name="telefono">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="direccion" class="form-label">Direcci√≥n *</label>
                        <input type="text" class="form-control" id="direccion" name="direccion" required>
                        <small class="form-text text-muted">Puedes pegar un link de Google Maps o escribir la direcci√≥n</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="latitud" class="form-label">Latitud *</label>
                                <input type="number" step="any" class="form-control" id="latitud" name="latitud" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="longitud" class="form-label">Longitud *</label>
                                <input type="number" step="any" class="form-control" id="longitud" name="longitud" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="categoria" class="form-label">Categor√≠a</label>
                        <select class="form-select" id="categoria" name="categoria">
                            <option value="Librer√≠a">üìö Librer√≠a</option>
                            <option value="Papeler√≠a">üìÑ Papeler√≠a</option>
                            <option value="Tienda Escolar">üéí Tienda Escolar</option>
                            <option value="Colegio">üè´ Colegio</option>
                            <option value="Universidad">üéì Universidad</option>
                            <option value="Oficina">üè¢ Oficina</option>
                            <option value="Distribuidor">üöö Distribuidor</option>
                            <option value="Bodega">üè≠ Bodega</option>
                            <option value="Casa">üè† Casa</option>
                            <option value="Otro">üì¶ Otro</option>
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <small>üí° <strong>Consejo:</strong> Para obtener coordenadas, ve a <a href="https://maps.google.com" target="_blank">Google Maps</a>, haz clic derecho en cualquier ubicaci√≥n y selecciona "¬øQu√© hay aqu√≠?"</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light py-3 modal-mobile-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-cliente">Guardar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Cliente -->
<div class="modal fade modal-mobile-fixed" id="editarClienteModal" tabindex="-1" aria-labelledby="editarClienteModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-mobile">
        <div class="modal-content border-0 shadow-lg modal-mobile-content">
            <div class="modal-header bg-primary text-white py-3 modal-mobile-header">
                <h5 class="modal-title fw-bold" id="editarClienteModalLabel">‚úèÔ∏è Editar Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 modal-mobile-body">
                <form id="form-editar-cliente">
                    <input type="hidden" id="editar-cliente-id" name="id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar-nombre" class="form-label">Nombre del Cliente *</label>
                                <input type="text" class="form-control" id="editar-nombre" name="nombre" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar-telefono" class="form-label">Tel√©fono</label>
                                <input type="text" class="form-control" id="editar-telefono" name="telefono">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar-direccion" class="form-label">Direcci√≥n *</label>
                        <input type="text" class="form-control" id="editar-direccion" name="direccion" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar-latitud" class="form-label">Latitud *</label>
                                <input type="number" step="any" class="form-control" id="editar-latitud" name="latitud" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editar-longitud" class="form-label">Longitud *</label>
                                <input type="number" step="any" class="form-control" id="editar-longitud" name="longitud" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editar-categoria" class="form-label">Categor√≠a</label>
                        <select class="form-select" id="editar-categoria" name="categoria">
                            <option value="Librer√≠a">üìö Librer√≠a</option>
                            <option value="Papeler√≠a">üìÑ Papeler√≠a</option>
                            <option value="Tienda Escolar">üéí Tienda Escolar</option>
                            <option value="Colegio">üè´ Colegio</option>
                            <option value="Universidad">üéì Universidad</option>
                            <option value="Oficina">üè¢ Oficina</option>
                            <option value="Distribuidor">üöö Distribuidor</option>
                            <option value="Bodega">üè≠ Bodega</option>
                            <option value="Casa">üè† Casa</option>
                            <option value="Otro">üì¶ Otro</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light py-3 modal-mobile-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-actualizar-cliente">üíæ Actualizar Cliente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gesti√≥n de Usuarios -->
<div class="modal fade modal-mobile-fixed" id="gestionUsuariosModal" tabindex="-1" aria-labelledby="gestionUsuariosModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-mobile">
        <div class="modal-content border-0 shadow-lg modal-mobile-content">
            <div class="modal-header bg-primary text-white py-3 modal-mobile-header">
                <h5 class="modal-title fw-bold" id="gestionUsuariosModalLabel">üë• Gesti√≥n de Usuarios</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 modal-mobile-body">
                <!-- Alertas -->
                <div id="alert-usuarios" class="alert" style="display: none;"></div>

                <div class="row">
                    <!-- Formulario para crear usuario -->
                    <div class="col-md-5">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">‚ûï Crear Nuevo Usuario</h5>
                            </div>
                            <div class="card-body">
                                <form id="form-crear-usuario">
                                    <div class="mb-3">
                                        <label for="username" class="form-label">Usuario *</label>
                                        <input type="text" class="form-control" id="username" name="username" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="password" class="form-label">Contrase√±a *</label>
                                        <input type="password" class="form-control" id="password" name="password" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="role" class="form-label">Tipo de Usuario *</label>
                                        <select class="form-select" id="role" name="role" required>
                                            <option value="trabajador">üöó Trabajador</option>
                                            <option value="admin">üëë Administrador</option>
                                        </select>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-success w-100" id="btn-crear-usuario">
                                        Crear Usuario
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de usuarios existentes -->
                    <div class="col-md-7">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">üìã Usuarios del Sistema</h5>
                                <span class="badge bg-light text-dark" id="contador-usuarios">0 usuarios</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 300px;">
                                    <table class="table table-striped table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Usuario</th>
                                                <th>Tipo</th>
                                                <th>Estado</th>
                                                <th>√öltimo Acceso</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabla-usuarios-body">
                                            <!-- Los usuarios se cargar√°n con JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light py-3 modal-mobile-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Usuario -->
<div class="modal fade modal-mobile-fixed" id="modalEditarUsuario" tabindex="-1" aria-labelledby="modalEditarUsuarioLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-mobile">
        <div class="modal-content border-0 shadow-lg modal-mobile-content">
            <div class="modal-header bg-primary text-white py-3 modal-mobile-header">
                <h5 class="modal-title fw-bold" id="modalEditarUsuarioLabel">‚úèÔ∏è Editar Usuario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 modal-mobile-body">
                <form id="form-editar-usuario">
                    <input type="hidden" id="editar-usuario-id">
                    
                    <div class="mb-3">
                        <label for="editar-username" class="form-label">Usuario *</label>
                        <input type="text" class="form-control" id="editar-username" name="username" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar-role" class="form-label">Tipo de Usuario *</label>
                        <select class="form-select" id="editar-role" name="role" required>
                            <option value="trabajador">üöó Trabajador</option>
                            <option value="admin">üëë Administrador</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar-password" class="form-label">Nueva Contrase√±a (dejar vac√≠o para no cambiar)</label>
                        <input type="password" class="form-control" id="editar-password" name="password">
                        <div class="form-text">Si no quieres cambiar la contrase√±a, deja este campo vac√≠o</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editar-activo" name="activo">
                        <label class="form-check-label" for="editar-activo">Usuario activo</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light py-3 modal-mobile-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-usuario">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaci√≥n para eliminar usuario -->
<div class="modal fade modal-mobile-fixed" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="modalConfirmarEliminarLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-mobile">
        <div class="modal-content border-0 shadow-lg modal-mobile-content">
            <div class="modal-header bg-warning text-dark py-3 modal-mobile-header">
                <h5 class="modal-title fw-bold" id="modalConfirmarEliminarLabel">‚ö†Ô∏è Confirmar Eliminaci√≥n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 modal-mobile-body">
                <p>¬øEst√°s seguro de que quieres eliminar al usuario <strong id="usuario-eliminar-nombre"></strong>?</p>
                <p class="text-danger"><small>Esta acci√≥n no se puede deshacer.</small></p>
            </div>
            <div class="modal-footer bg-light py-3 modal-mobile-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-eliminar">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Reiniciar Contrase√±a -->
<div class="modal fade modal-mobile-fixed" id="modalResetPassword" tabindex="-1" aria-labelledby="modalResetPasswordLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-mobile">
        <div class="modal-content border-0 shadow-lg modal-mobile-content">
            <div class="modal-header bg-warning text-dark py-3 modal-mobile-header">
                <h5 class="modal-title fw-bold" id="modalResetPasswordLabel">üîë Reiniciar Contrase√±a</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 modal-mobile-body">
                <p>Reiniciar contrase√±a para: <strong id="usuario-reset-nombre"></strong></p>
                <div class="mb-3">
                    <label for="nueva-password" class="form-label">Nueva Contrase√±a</label>
                    <input type="password" class="form-control" id="nueva-password" value="123456">
                    <div class="form-text">Contrase√±a por defecto: 123456</div>
                </div>
            </div>
            <div class="modal-footer bg-light py-3 modal-mobile-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btn-confirmar-reset">üîë Reiniciar Contrase√±a</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Todos los Clientes -->
<div class="modal fade modal-mobile-fixed" id="modalTodosClientes" tabindex="-1" aria-labelledby="modalTodosClientesLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen-mobile">
        <div class="modal-content border-0 shadow-lg modal-mobile-content">
            <div class="modal-header bg-primary text-white py-3 modal-mobile-header">
                <h5 class="modal-title fw-bold" id="modalTodosClientesLabel">üë• Todos los Clientes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3 modal-mobile-body">
                <!-- Contador -->
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <span class="text-muted small" id="contador-clientes-modal">Cargando...</span>
                    <small class="text-muted badge bg-light text-dark">Orden alfab√©tico</small>
                </div>
                
                <!-- Tabla compacta y responsive -->
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="fw-semibold">Nombre</th>
                                <th class="fw-semibold d-none d-md-table-cell">Direcci√≥n</th>
                                <th class="fw-semibold d-none d-sm-table-cell">Tel√©fono</th>
                                <th class="fw-semibold">Categor√≠a</th>
                                <th class="fw-semibold text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpo-tabla-clientes-modal">
                            <!-- Los clientes se cargar√°n aqu√≠ con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light py-3 modal-mobile-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}

{% block styles %}
<style>
    /* üî• SCROLL INVISIBLE DEFINITIVO */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    
    .container-fluid {
        height: 100vh;
    }
    
    .row {
        height: 100%;
    }
    
    .main-content {
        height: 100%;
        overflow-y: auto;
        padding-bottom: 20px;
    }
    
    /* Scroll invisible */
    .main-content::-webkit-scrollbar {
        display: none;
    }
    
    .main-content {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* üî• SOLUCI√ìN DEFINITIVA PARA M√ìVILES - MODALES QUE CABEN EN PANTALLA */
    .modal-mobile-fixed {
        z-index: 9999 !important;
    }
    
    .modal-mobile-fixed .modal-dialog {
        z-index: 10000 !important;
    }
    
    .modal-mobile-content {
        z-index: 10001 !important;
    }

    /* üî• MODALES QUE SIEMPRE CABEN EN M√ìVIL - SIN SOBREPASAR */
    @media (max-width: 768px) {
        .modal-fullscreen-mobile {
            max-width: 100% !important;
            max-height: 100% !important;
            margin: 0 !important;
            height: 100% !important;
            width: 100% !important;
        }
        
        .modal-mobile-content {
            height: 100vh !important;
            border-radius: 0 !important;
            margin: 0 !important;
            max-height: 100vh !important; /* üî• NUEVO: LIMITE M√ÅXIMO */
        }
        
        .modal-mobile-header {
            position: sticky;
            top: 0;
            z-index: 10002;
            border-radius: 0 !important;
            min-height: 60px !important; /* üî• NUEVO: ALTURA FIJA */
            max-height: 60px !important; /* üî• NUEVO: NO CRECE */
        }
        
        .modal-mobile-body {
            max-height: calc(100vh - 120px) !important; /* üî• CORREGIDO: 100vh - (header + footer) */
            min-height: auto !important;
            overflow-y: auto !important;
            padding: 1rem !important;
            flex: 1 !important; /* üî• NUEVO: OCUPA ESPACIO DISPONIBLE */
        }
        
        .modal-mobile-footer {
            position: sticky;
            bottom: 0;
            z-index: 10002;
            border-radius: 0 !important;
            background: white !important;
            border-top: 1px solid #dee2e6 !important;
            min-height: 60px !important; /* üî• NUEVO: ALTURA FIJA */
            max-height: 60px !important; /* üî• NUEVO: NO CRECE */
        }
        
        /* Asegurar que el modal ocupe exactamente la pantalla */
        .modal-mobile-fixed.show .modal-dialog {
            transform: none !important;
            display: flex !important;
            align-items: stretch !important;
            min-height: 100vh !important;
            max-height: 100vh !important; /* üî• NUEVO: NO SOBREPASA */
        }
        
        /* Contenedor del modal que limita el tama√±o */
        .modal-mobile-fixed .modal-content {
            max-height: 100vh !important; /* üî• NUEVO: M√ÅXIMO VIEWPORT */
            overflow: hidden !important;
        }
        
        /* Fondo del modal m√°s oscuro en m√≥viles */
        .modal-backdrop {
            z-index: 9998 !important;
            background-color: rgba(0, 0, 0, 0.8) !important;
        }
        
        /* Header fijo del admin con z-index m√°s bajo */
        .admin-header {
            z-index: 100 !important;
            position: relative;
        }
    }

    /* üî• COMPORTAMIENTO NORMAL EN ESCRITORIO */
    @media (min-width: 769px) {
        .modal-fullscreen-mobile {
            max-width: 800px;
            max-height: 80vh;
        }
        
        .modal-mobile-content {
            height: auto;
            border-radius: 12px;
            max-height: 80vh !important;
        }
        
        .modal-mobile-body {
            max-height: 60vh;
        }
    }

    /* üî• MEJORAS ESPEC√çFICAS PARA M√ìVILES PEQUE√ëOS */
    @media (max-width: 576px) {
        .modal-mobile-body {
            padding: 0.75rem !important;
            max-height: calc(100vh - 110px) !important; /* üî• AJUSTE PARA M√ìVILES PEQUE√ëOS */
        }
        
        .modal-mobile-header,
        .modal-mobile-footer {
            padding: 0.75rem !important;
            min-height: 55px !important; /* üî• M√ÅS COMPACTO EN M√ìVILES PEQUE√ëOS */
            max-height: 55px !important;
        }
        
        .form-control, .form-select {
            font-size: 16px !important; /* Evita zoom en iOS */
        }
        
        /* Botones m√°s grandes en m√≥viles */
        .btn {
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }
        
        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
        }
    }

    /* üî• M√ìVILES MUY PEQUE√ëOS (iPhone SE) */
    @media (max-width: 375px) {
        .modal-mobile-body {
            max-height: calc(100vh - 100px) !important; /* üî• M√ÅS ESPACIO EN PANTALLAS PEQUE√ëAS */
            padding: 0.5rem !important;
        }
        
        .modal-mobile-header,
        .modal-mobile-footer {
            min-height: 50px !important;
            max-height: 50px !important;
            padding: 0.5rem !important;
        }
    }

    /* üî• MEJORAS PARA TABLETS */
    @media (min-width: 577px) and (max-width: 768px) {
        .modal-fullscreen-mobile {
            max-width: 95%;
            max-height: 90vh;
            margin: 2.5vh auto !important;
        }
        
        .modal-mobile-content {
            height: 90vh;
            border-radius: 12px;
            max-height: 90vh !important;
        }
        
        .modal-mobile-body {
            max-height: calc(90vh - 120px);
        }
    }

    /* üî• GARANTIZAR QUE LOS MODALES SIEMPRE EST√âN POR ENCIMA */
    .modal {
        z-index: 9999 !important;
    }
    
    .modal-dialog {
        z-index: 10000 !important;
    }
    
    .modal-content {
        z-index: 10001 !important;
    }

    /* üî• SUGERENCIAS DROPDOWN RESPONSIVE */
    .sugerencias-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 10002;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .sugerencia-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .sugerencia-item:hover, .sugerencia-item.active {
        background-color: #f8f9fa;
    }
    
    .sugerencia-item:last-child {
        border-bottom: none;
    }

    /* Responsive mejorado para buscadores */
    @media (max-width: 576px) {
        .main-content {
            padding-left: 10px;
            padding-right: 10px;
        }
        #buscador-clientes {
            width: 150px !important;
        }
        
        /* Mejorar visibilidad del header en m√≥vil */
        .d-flex.justify-content-between {
            flex-wrap: wrap;
        }
        
        .btn-toolbar {
            margin-top: 10px;
        }
    }

    /* üî• MEJORAS ESPEC√çFICAS PARA EL MODAL DE GESTI√ìN DE USUARIOS */
    @media (max-width: 768px) {
        #gestionUsuariosModal .row {
            flex-direction: column;
        }
        
        #gestionUsuariosModal .col-md-5,
        #gestionUsuariosModal .col-md-7 {
            width: 100%;
            margin-bottom: 1rem;
        }
        
        #tabla-usuarios-body .btn-group {
            display: flex;
            flex-wrap: wrap;
        }
        
        #tabla-usuarios-body .btn-group .btn {
            margin: 1px;
            flex: 1;
            min-width: 40px;
        }
    }

    /* üî• CORRECCI√ìN DEFINITIVA: PREVENIR SCROLL SIN ROMPER LAYOUT */
    body.modal-open-mobile {
        overflow: hidden !important;
        position: relative !important;
        height: 100% !important;
    }

    /* üî• ASEGURAR QUE EL BACKDROP CUBRA TODA LA PANTALLA */
    .modal-backdrop {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9998 !important;
    }

    /* üî• FORZAR QUE EL MODAL USE FLEXBOX PARA DISTRIBUIR ESPACIO */
    .modal-mobile-fixed .modal-dialog {
        display: flex !important;
        flex-direction: column !important;
    }
    
    .modal-mobile-content {
        display: flex !important;
        flex-direction: column !important;
        flex: 1 !important;
    }
    
    .modal-mobile-body {
        flex: 1 !important;
        overflow-y: auto !important;
    }
</style>

<script>
// Botones de backup en men√∫ offcanvas
document.addEventListener('DOMContentLoaded', function() {
    const enlacesMenu = document.querySelectorAll('#adminOffcanvas a[href]');
    
    enlacesMenu.forEach(enlace => {
        enlace.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            
            if (href.includes('/admin/backup') || href.includes('/admin/estado-db')) {
                e.preventDefault();
                window.open(href, '_blank');
                
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('adminOffcanvas'));
                if (offcanvas) {
                    offcanvas.hide();
                }
            }
        });
    });
});

// üî• SOLUCI√ìN DEFINITIVA PARA MODALES EN M√ìVILES - MEJORADA
document.addEventListener('DOMContentLoaded', function() {
    // Forzar modales en m√≥viles
    if (window.innerWidth <= 768) {
        const modales = document.querySelectorAll('.modal-mobile-fixed');
        
        modales.forEach(modal => {
            // Configurar evento para cuando se abre el modal
            modal.addEventListener('show.bs.modal', function() {
                console.log('üì± Modal m√≥vil abri√©ndose...');
                // Solo ocultar scroll, NO cambiar position
                document.body.style.overflow = 'hidden';
                document.body.classList.add('modal-open-mobile');
                
                // üî• FORZAR TAMA√ëO CORRECTO INMEDIATAMENTE
                setTimeout(() => {
                    const modalContent = this.querySelector('.modal-content');
                    const modalBody = this.querySelector('.modal-body');
                    const modalHeader = this.querySelector('.modal-header');
                    const modalFooter = this.querySelector('.modal-footer');
                    
                    if (modalContent) {
                        modalContent.style.maxHeight = '100vh';
                        modalContent.style.height = '100vh';
                    }
                    if (modalBody) {
                        modalBody.style.maxHeight = 'calc(100vh - 120px)';
                    }
                }, 50);
            });
            
            modal.addEventListener('shown.bs.modal', function() {
                console.log('‚úÖ Modal m√≥vil completamente visible');
                
                // üî• VERIFICACI√ìN FINAL DE TAMA√ëOS
                const modalContent = this.querySelector('.modal-content');
                const modalBody = this.querySelector('.modal-body');
                
                console.log('üìè Altura del modal content:', modalContent?.offsetHeight);
                console.log('üìè Altura del modal body:', modalBody?.offsetHeight);
                console.log('üìê Altura de la ventana:', window.innerHeight);
            });
            
            // Configurar evento para cuando se cierra el modal
            modal.addEventListener('hidden.bs.modal', function() {
                // Restaurar scroll
                document.body.style.overflow = '';
                document.body.classList.remove('modal-open-mobile');
            });
        });
    }
});

// üî• AJUSTAR MODALES AL CAMBIAR ORIENTACI√ìN DEL DISPOSITIVO
window.addEventListener('orientationchange', function() {
    const modalAbierto = document.querySelector('.modal-mobile-fixed.show');
    if (modalAbierto && window.innerWidth <= 768) {
        // Forzar redibujado del modal con nuevos c√°lculos
        setTimeout(() => {
            const modalDialog = modalAbierto.querySelector('.modal-dialog');
            const modalContent = modalAbierto.querySelector('.modal-content');
            const modalBody = modalAbierto.querySelector('.modal-body');
            
            if (modalDialog) {
                modalDialog.style.transform = 'translateY(0)';
            }
            if (modalContent) {
                modalContent.style.maxHeight = '100vh';
                modalContent.style.height = '100vh';
            }
            if (modalBody) {
                modalBody.style.maxHeight = 'calc(100vh - 120px)';
            }
        }, 300);
    }
});

// üî• CORRECCI√ìN EXTRA: AJUSTAR AL CARGAR LA P√ÅGINA EN M√ìVIL
if (window.innerWidth <= 768) {
    document.addEventListener('DOMContentLoaded', function() {
        // Pre-cargar c√°lculos para m√≥viles
        console.log('üì± Dispositivo m√≥vil detectado, configurando modales...');
    });
}
</script>

{% endblock %}